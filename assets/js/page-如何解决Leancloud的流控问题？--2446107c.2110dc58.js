(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{560:function(t,a,e){"use strict";e.r(a);var r=e(2),s=Object(r.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1.8/images/lncld.png",alt:"avatar"}})]),t._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),e("p",[t._v("最近登上Leancloud的后台，发现云引擎的日志里满屏都是这么一句话")]),t._v(" "),e("p",[e("strong",[t._v('CloudQueue 运行失败 xxxxx : self_wake !! {"error":"因流控原因，通过定时任务唤醒体验版实例失败，建议升级至标准版云引擎实例避免休眠 https://url.leanapp.cn/dwAEksv"}')])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/bqb1.jpg",alt:"avatar"}})]),t._v(" "),e("p",[t._v("然后我点了这个链接进去看了看，官方给出的说明是这样的")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/leancloud1.png",alt:"avatar"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/leancloud2.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("也就是说Leancloud觉得我们白嫖得太厉害了，不给我们通过定时任务来唤醒容器了")]),t._v(" "),e("details",[e("summary",[t._v("通俗易懂小剧场1")]),t._v(" "),e("pre",[t._v("容器：今天又是元气满满的一天\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：收到收到\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：收到收到\n...\n[日志]容器运行满18小时，需要在夜间休眠6小时\n第二天\n定时唤醒任务：hxd，醒醒，该干活了\n容器：啊巴啊巴啊巴啊巴啊巴.....(休眠中)\n20分钟后\n定时唤醒任务：hxd，醒醒，该干活了\n容器：啊巴啊巴啊巴啊巴啊巴.....(休眠中)\n...\n当有外部请求时\n容器：嗯，有外部请求了？好了我醒了\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：Yes♂Sir\n...\n")])]),t._v(" "),e("p",[t._v("现在我们不能通过定时任务唤醒休眠的容器了，但还能唤醒正在运行的容器来延长运行时间")]),t._v(" "),e("p",[t._v("于是我又去网上找了各种方法，找到了一个我认为最好的解决方案")]),t._v(" "),e("h2",{attrs:{id:"解决方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),e("p",[t._v("虽然现在Leancloud不能通过内部请求来唤醒容器，那我们还能通过外部请求嘛")]),t._v(" "),e("h3",{attrs:{id:"github-actions"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#github-actions"}},[t._v("#")]),t._v(" Github Actions")]),t._v(" "),e("p",[t._v("打开Github，进入你的个人设置(Settings)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github1.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("点击开发者设置(Developer Settings)，找到个人访问密匙(Personal access tokens)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github2.png",alt:"avatar"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github3.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("创建一个新的密匙(点击Generate new token)，名称为"),e("code",[t._v("GITHUB_TOKEN")]),t._v("，勾选 "),e("code",[t._v("repo")]),t._v(" "),e("code",[t._v("admin:repo_hook")]),t._v(" "),e("code",[t._v("workflow")]),t._v(" 选项，然后生成密匙即可(点击Generate token)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github4.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("然后我们需要Fork一个项目")]),t._v(" "),e("p",[t._v("项目地址："),e("a",{attrs:{href:"https://github.com/blogimg/WakeLeanCloud",target:"_blank",rel:"noopener noreferrer"}},[t._v("WakeLeanCloud"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("Fork完毕后，进入项目的设置（点击Settings），找到Secrets，新建一个Secret(点击New Secret)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github5.png",alt:"avatar"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github6.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("名称为"),e("code",[t._v("SITE")]),t._v("，"),e("code",[t._v("Value")]),t._v("为你的博客评论系统后台管理地址，可填多个地址，用"),e("code",[t._v(",")]),t._v("分开，然后点击Add secret 添加secret")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github7.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("然后我们可以给自己的项目点个Star(手动执行一次Actions)，然后点击Actions看看运行成功没有，如果你是第一次用Actions，那么会有一个使用提示，点击绿色的按钮即可")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github8.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("如果Actions运行成功了，那么它看起来是这样的")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github9.png",alt:"avatar"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github10.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("之后它就会在每天的8点到23点里，每20分钟唤醒Leancloud容器一次啦")]),t._v(" "),e("p",[t._v("PS：由于唤醒大约耗时2分钟，所以唤醒脚本里的cron表达式是18而不是20")]),t._v(" "),e("p",[t._v("如果你想改时间，那么修改"),e("code",[t._v(".github/workflows/autoWakeup.yml")]),t._v("中的cron表达式即可")]),t._v(" "),e("p",[t._v("PS：时区默认为UTC，我们的时区是UTC+8，所以你的时间需要减8个小时")]),t._v(" "),e("p",[t._v("这里奉上一个cron表达式的生成器："),e("a",{attrs:{href:"https://www.beejson.com/tool/cron.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Link"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github11.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("如果你嫌commit多太烦人，那么可以设置为外部唤醒一次，其余都交给Leancloud的定时任务来唤醒即可")]),t._v(" "),e("p",[t._v("比如我将"),e("code",[t._v(".github/workflows/autoWakeup.yml")]),t._v("中的cron表达式改为"),e("code",[t._v("55 22 * * *")])]),t._v(" "),e("p",[t._v("那么它就会在每天早上6点55分唤醒Leancloud容器一次啦")]),t._v(" "),e("details",[e("summary",[t._v("通俗易懂小剧场2")]),t._v(" "),e("pre",[t._v("外部请求多次\n外部请求(首次)：铁子，该干活了\n容器：OKOK\n20分钟后\n外部请求：老哥，还有活要干，别休眠了\n容器：OKOK\n...\n外部请求一次\n外部请求：起床干活GKD\n容器：好der\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：收到收到\n...\n")])]),t._v(" "),e("p",[t._v("我用的是只发送一次外部请求的方法，这里奉上我在Leancloud定时任务中的cron表达式")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/leancloud3.png",alt:"avatar"}})]),t._v(" "),e("p",[t._v("先在早上6点55分外部请求唤醒容器，然后从7点开始23点结束，每20分钟内部唤醒容器一次，同时在7点5分补上漏发的邮件，这样也能达到延长容器运行时间的目的")]),t._v(" "),e("h2",{attrs:{id:"后记"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#后记"}},[t._v("#")]),t._v(" 后记")]),t._v(" "),e("p",[t._v("其实还有其他方案的，不过我认为这个方案是最好的，有空再写其他的")]),t._v(" "),e("p",[t._v("看着满屏的"),e("code",[t._v("self_wake")]),t._v("函数运行成功，心里真TM爽")]),t._v(" "),e("p",[t._v("最后感谢"),e("a",{attrs:{href:"https://www.antmoe.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dreamy.TZK"),e("OutboundLink")],1),t._v("的文章和项目")]),t._v(" "),e("h2",{attrs:{id:"感谢"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#感谢"}},[t._v("#")]),t._v(" 感谢")]),t._v(" "),e("h3",{attrs:{id:"部分图片"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部分图片"}},[t._v("#")]),t._v(" 部分图片")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.antmoe.com/posts/ff6aef7b/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("优雅解决Leancloud流控问题"),e("OutboundLink")],1)])]),t._v(" "),e("h3",{attrs:{id:"文章"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文章"}},[t._v("#")]),t._v(" 文章")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://www.antmoe.com/posts/ff6aef7b/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("优雅解决Leancloud流控问题"),e("OutboundLink")],1)])]),t._v(" "),e("h3",{attrs:{id:"项目"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目"}},[t._v("#")]),t._v(" 项目")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/blogimg/WakeLeanCloud",target:"_blank",rel:"noopener noreferrer"}},[t._v("WakeLeanCloud"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("文章更新日期：2020.6.21 18:40")])])}),[],!1,null,null,null);a.default=s.exports}}]);