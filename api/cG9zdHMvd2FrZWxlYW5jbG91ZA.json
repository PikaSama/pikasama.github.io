{"title":"如何解决Leancloud的流控问题？","date":"2020-06-20T12:09:44.000Z","date_formatted":{"ll":"2020年6月20日","L":"2020/06/20","MM-DD":"06-20"},"thumbnail":"//cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1.8/images/lncld.png","link":"posts/wakeleancloud","comments":true,"tags":["Leancloud"],"categories":["开发"],"updated":"2020-12-06T09:11:42.306Z","content":"<h2 id=\"前言\">前言<a title=\"#前言\" href=\"#前言\"></a></h2>\n<p>最近登上Leancloud的后台，发现云引擎的日志里满屏都是这么一句话</p>\n<p><strong>CloudQueue 运行失败 xxxxx : self_wake !! {“error”:“因流控原因，通过定时任务唤醒体验版实例失败，建议升级至标准版云引擎实例避免休眠 <a href=\"https://url.leanapp.cn/dwAEksv\">https://url.leanapp.cn/dwAEksv</a>”}</strong></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/bqb1.jpg\" alt=\"avatar\" class=\"φcx\"></p>\n<a id=\"more\"></a>\n<p>然后我点了这个链接进去看了看，官方给出的说明是这样的</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/leancloud1.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/leancloud2.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>也就是说Leancloud觉得我们白嫖得太厉害了，不给我们通过定时任务来唤醒容器了</p>\n<details>\n<summary>通俗易懂小剧场1</summary>\n<pre>\n容器：今天又是元气满满的一天\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：收到收到\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：收到收到\n...\n[日志]容器运行满18小时，需要在夜间休眠6小时\n第二天\n定时唤醒任务：hxd，醒醒，该干活了\n容器：啊巴啊巴啊巴啊巴啊巴.....(休眠中)\n20分钟后\n定时唤醒任务：hxd，醒醒，该干活了\n容器：啊巴啊巴啊巴啊巴啊巴.....(休眠中)\n...\n当有外部请求时\n容器：嗯，有外部请求了？好了我醒了\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：Yes♂Sir\n...\n</pre>\n</details>\n<p>现在我们不能通过定时任务唤醒休眠的容器了，但还能唤醒正在运行的容器来延长运行时间</p>\n<p>于是我又去网上找了各种方法，找到了一个我认为最好的解决方案</p>\n<h2 id=\"解决方案\">解决方案<a title=\"#解决方案\" href=\"#解决方案\"></a></h2>\n<p>虽然现在Leancloud不能通过内部请求来唤醒容器，那我们还能通过外部请求嘛</p>\n<h3 id=\"github-actions\">Github Actions<a title=\"#github-actions\" href=\"#github-actions\"></a></h3>\n<p>打开Github，进入你的个人设置(Settings)</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github1.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>点击开发者设置(Developer Settings)，找到个人访问密匙(Personal access tokens)</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github2.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github3.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>创建一个新的密匙(点击Generate new token)，名称为<code>GITHUB_TOKEN</code>，勾选 <code>repo</code> <code>admin:repo_hook</code> <code>workflow</code> 选项，然后生成密匙即可(点击Generate token)</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github4.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>然后我们需要Fork一个项目</p>\n<p>项目地址：<a href=\"https://github.com/blogimg/WakeLeanCloud\" target=\"_blank\">WakeLeanCloud</a></p>\n<p>Fork完毕后，进入项目的设置（点击Settings），找到Secrets，新建一个Secret(点击New Secret)</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github5.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github6.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>名称为<code>SITE</code>，<code>Value</code>为你的博客评论系统后台管理地址，可填多个地址，用<code>,</code>分开，然后点击Add secret 添加secret</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github7.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>然后我们可以给自己的项目点个Star(手动执行一次Actions)，然后点击Actions看看运行成功没有，如果你是第一次用Actions，那么会有一个使用提示，点击绿色的按钮即可</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github8.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>如果Actions运行成功了，那么它看起来是这样的</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github9.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github10.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>之后它就会在每天的8点到23点里，每20分钟唤醒Leancloud容器一次啦</p>\n<p>PS：由于唤醒大约耗时2分钟，所以唤醒脚本里的cron表达式是18而不是20</p>\n<p>如果你想改时间，那么修改<code>.github/workflows/autoWakeup.yml</code>中的cron表达式即可</p>\n<p>PS：时区默认为UTC，我们的时区是UTC+8，所以你的时间需要减8个小时</p>\n<p>这里奉上一个cron表达式的生成器：<a href=\"https://www.beejson.com/tool/cron.html\" target=\"_blank\">Link</a></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/github11.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>如果你嫌commit多太烦人，那么可以设置为外部唤醒一次，其余都交给Leancloud的定时任务来唤醒即可</p>\n<p>比如我将<code>.github/workflows/autoWakeup.yml</code>中的cron表达式改为<code>55 22 * * *</code></p>\n<p>那么它就会在每天早上6点55分唤醒Leancloud容器一次啦</p>\n<details>\n<summary>通俗易懂小剧场2</summary>\n<pre>\n外部请求多次\n外部请求(首次)：铁子，该干活了\n容器：OKOK\n20分钟后\n外部请求：老哥，还有活要干，别休眠了\n容器：OKOK\n...\n外部请求一次\n外部请求：起床干活GKD\n容器：好der\n20分钟后\n定时唤醒任务：hxd，醒醒，别那么早就休眠了，你还有活要干\n容器：收到收到\n...\n</pre>\n</details>\n<p>我用的是只发送一次外部请求的方法，这里奉上我在Leancloud定时任务中的cron表达式</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/PikaSama/shelter-images@1.1/images/leancloud3.png\" alt=\"avatar\" class=\"φcx\"></p>\n<p>先在早上6点55分外部请求唤醒容器，然后从7点开始23点结束，每20分钟内部唤醒容器一次，同时在7点5分补上漏发的邮件，这样也能达到延长容器运行时间的目的</p>\n<h2 id=\"后记\">后记<a title=\"#后记\" href=\"#后记\"></a></h2>\n<p>其实还有其他方案的，不过我认为这个方案是最好的，有空再写其他的</p>\n<p>看着满屏的<code>self_wake</code>函数运行成功，心里真TM爽</p>\n<p>最后感谢<a href=\"https://www.antmoe.com\" target=\"_blank\">Dreamy.TZK</a>的文章和项目</p>\n<h2 id=\"感谢\">感谢<a title=\"#感谢\" href=\"#感谢\"></a></h2>\n<h3 id=\"部分图片\">部分图片<a title=\"#部分图片\" href=\"#部分图片\"></a></h3>\n<ul>\n<li><a href=\"https://www.antmoe.com/posts/ff6aef7b/index.html\" target=\"_blank\">优雅解决Leancloud流控问题</a></li>\n</ul>\n<h3 id=\"文章\">文章<a title=\"#文章\" href=\"#文章\"></a></h3>\n<ul>\n<li><a href=\"https://www.antmoe.com/posts/ff6aef7b/index.html\" target=\"_blank\">优雅解决Leancloud流控问题</a></li>\n</ul>\n<h3 id=\"项目\">项目<a title=\"#项目\" href=\"#项目\"></a></h3>\n<ul>\n<li><a href=\"https://github.com/blogimg/WakeLeanCloud\" target=\"_blank\">WakeLeanCloud</a></li>\n</ul>\n<p>文章更新日期：2020.6.21 18:40</p>\n","prev":{"title":"[持续更新]Inside主题进阶配置","link":"posts/inside-configuration"},"next":{"title":"星与你，消失之日","link":"posts/honkai-star"},"plink":"https://shelter.beaa.cn/posts/wakeleancloud/","toc":[{"id":"前言","title":"前言","index":"1"},{"id":"解决方案","title":"解决方案","index":"2","children":[{"id":"github-actions","title":"Github Actions","index":"2.1"}]},{"id":"后记","title":"后记","index":"3"},{"id":"感谢","title":"感谢","index":"4","children":[{"id":"部分图片","title":"部分图片","index":"4.1"},{"id":"文章","title":"文章","index":"4.2"},{"id":"项目","title":"项目","index":"4.3"}]}],"reward":true,"copyright":{"author":"Zorin","link":"<a href=\"https://shelter.beaa.cn/posts/wakeleancloud/\" title=\"如何解决Leancloud的流控问题？\">https://shelter.beaa.cn/posts/wakeleancloud/</a>","license":"<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"nofollow\" target=\"_blank\">署名-非商业性-共享方式一致</a>(CC BY-NC-SA 4.0)<br />博客除特别声明外，均采用此协议，转载请注明来源！"}}